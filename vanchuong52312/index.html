<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Magic Christmas - Optimized</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <style>
    html,body { height:100%; margin:0; background:#000; overflow:hidden; font-family:'Segoe UI'; }
    #canvas-container { width:100%; height:100vh; position:relative; }
    #ui-layer { position:absolute; bottom:30px; width:100%; text-align:center; pointer-events:none; z-index:100;}
    .guide{color:rgba(255,255,255,0.65); font-size:13px; margin-bottom:12px;}
    button {pointer-events:auto; cursor:pointer; background:#a60000; color:#fff; border:2px solid gold; padding:12px 40px; border-radius:30px; font-weight:800;}
    #camera-preview { position:absolute; top:12px; right:12px; width:120px; height:90px; border:1px solid rgba(255,0,0,0.5); opacity:0.55; transform:scaleX(-1);}
  </style>
</head>
<body>

<div id="ui-layer">
  <div class="guide">üñê Open = Explode &nbsp;|&nbsp; ü´∂ Heart = Love &nbsp;|&nbsp; ‚úä Fist = Tree</div>
  <button id="btnStart" onclick="startSystem()">START MAGIC</button>
</div>

<div id="canvas-container"></div>

<video class="input_video" style="display:none" playsinline muted></video>
<canvas id="camera-preview" width="120" height="90"></canvas>

<script>
/* ********************************************
   OPTIMIZED SETTINGS
******************************************** */

const MUSIC_URL = "./audio.mp3";
const bgMusic = new Audio(MUSIC_URL);
bgMusic.loop = true;
bgMusic.volume = 1.0;

const loader = new THREE.TextureLoader();
const photoFiles = ['./image1.jpeg','./image2.jpeg','./image3.jpeg','./image4.jpeg','./image5.jpeg'];
const photoTextures = [];

// preload images with fallback
photoFiles.forEach((f,i) => {
  loader.load(f, tex => photoTextures[i]=tex, undefined, () => {
    const c=document.createElement('canvas'); c.width=64;c.height=64;
    const x=c.getContext('2d');
    x.fillStyle='#333'; x.fillRect(0,0,64,64);
    x.fillStyle='#fff'; x.fillText('NO',15,35);
    photoTextures[i]=new THREE.CanvasTexture(c);
  });
});

/* ********************************************
   VERY HEAVY EFFECT REDUCTION FOR MOBILE
******************************************** */

const CONFIG = {
  goldCount: 2000,
  redCount: 300,
  giftCount: 150,
  explodeRadius: 65,
  photoOrbitRadius: 25,
  treeHeight: 70,
  treeBaseRadius: 35
};

// üî• Mobile optimization ‚Äî MUCH STRONGER
if(window.innerWidth < 700){
  CONFIG.goldCount = Math.round(CONFIG.goldCount * 0.15);
  CONFIG.redCount  = Math.round(CONFIG.redCount  * 0.20);
  CONFIG.giftCount = Math.round(CONFIG.giftCount * 0.20);
}

// global vars
let scene, camera, renderer;
let groupGold, groupRed, groupGift;
let photoMeshes = [];
let titleMesh, starMesh, loveMesh;
let state='TREE', selectedIndex=0, handX=0.5;

/* ********************************************
   MAIN 3D SETUP
******************************************** */
function init3D(){
  const container = document.getElementById("canvas-container");

  scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(0x000000,0.002);

  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.z = 100;

  renderer = new THREE.WebGLRenderer({ antialias:false });
  renderer.setSize(window.innerWidth, window.innerHeight);

  // IMPORTANT: reduce pixel ratio for speed
  renderer.setPixelRatio(1);

  container.appendChild(renderer.domElement);

  groupGold = createParticle("gold", CONFIG.goldCount, 2.0);
  groupRed  = createParticle("red",  CONFIG.redCount,  3.2);
  groupGift = createParticle("gift", CONFIG.giftCount, 3.0);

  createPhotos();
  createTexts();
  animate();
}

function createParticle(type,count,size){
  const geo = new THREE.BufferGeometry();
  const pos = new Float32Array(count*3);
  const targetTree = new Float32Array(count*3);
  const targetExplode = new Float32Array(count*3);
  const targetHeart = new Float32Array(count*3);

  for(let i=0;i<count;i++){
    const h = Math.random()*CONFIG.treeHeight;
    const y = h - CONFIG.treeHeight/2;
    const maxR = (1-(h/CONFIG.treeHeight))*CONFIG.treeBaseRadius;
    const r   = maxR*Math.sqrt(Math.random());
    const t   = Math.random()*Math.PI*2;

    targetTree[i*3]   = r*Math.cos(t);
    targetTree[i*3+1] = y;
    targetTree[i*3+2] = r*Math.sin(t);

    // explode
    const u=Math.random(),v=Math.random();
    const phi=Math.acos(2*v-1), lam=2*Math.PI*u;
    const rad=CONFIG.explodeRadius*Math.cbrt(Math.random());
    targetExplode[i*3]   = rad*Math.sin(phi)*Math.cos(lam);
    targetExplode[i*3+1] = rad*Math.sin(phi)*Math.sin(lam);
    targetExplode[i*3+2] = rad*Math.cos(phi);

    // heart
    const tt=Math.random()*Math.PI*2;
    let hx=16*Math.pow(Math.sin(tt),3);
    let hy=13*Math.cos(tt)-5*Math.cos(2*tt)-2*Math.cos(3*tt)-Math.cos(4*tt);
    const fill=Math.pow(Math.random(),0.3);
    hx*=fill; hy*=fill;
    const hz=(Math.random()-0.5)*8*fill;
    targetHeart[i*3]   = hx*2.2;
    targetHeart[i*3+1] = hy*2.2+5;
    targetHeart[i*3+2] = hz;

    pos[i*3]   = targetTree[i*3];
    pos[i*3+1] = targetTree[i*3+1];
    pos[i*3+2] = targetTree[i*3+2];
  }

  geo.setAttribute("position", new THREE.BufferAttribute(pos,3));
  geo.userData = { tree:targetTree, explode:targetExplode, heart:targetHeart };

  const mat = new THREE.PointsMaterial({
    size:size,
    transparent:true,
    opacity:1.0,
    color:(type==="gold")?0xffd700:(type==="red"?0xff0000:0xffffff),
    depthWrite:false
  });

  const pts = new THREE.Points(geo,mat);
  scene.add(pts);
  return pts;
}

function createPhotos(){
  const geo = new THREE.PlaneGeometry(8,8);
  for(let i=0;i<photoFiles.length;i++){
    const m = new THREE.Mesh(
      geo,
      new THREE.MeshBasicMaterial({ map: photoTextures[i], side: THREE.DoubleSide })
    );
    m.visible=false;
    m.scale.set(0,0,0);
    photoMeshes.push(m);
    scene.add(m);
  }
}

function createTexts(){
  const canvas=document.createElement("canvas");
  canvas.width=1024; canvas.height=256;
  const ctx=canvas.getContext("2d");

  ctx.font='bold 90px "Times New Roman"';
  ctx.fillStyle="#FFD700";
  ctx.textAlign="center";
  ctx.fillText("MERRY CHRISTMAS",512,140);

  titleMesh=new THREE.Mesh(
    new THREE.PlaneGeometry(60,15),
    new THREE.MeshBasicMaterial({ map:new THREE.CanvasTexture(canvas), transparent:true })
  );
  titleMesh.position.set(0,50,0);
  scene.add(titleMesh);

  loveMesh = new THREE.Mesh(
    new THREE.PlaneGeometry(70,18),
    new THREE.MeshBasicMaterial({ color:0xff69b4, transparent:true })
  );
  loveMesh.visible=false;
  scene.add(loveMesh);
}

/* ********************************************
   ANIMATION LOOP (LIGHTER)
******************************************** */
function animate(){
  requestAnimationFrame(animate);

  const t = performance.now()*0.001;

  updateParticles(groupGold,'gold');
  updateParticles(groupRed,'red');
  updateParticles(groupGift,'gift');

  if(state==='HEART'){
    loveMesh.visible=true;
    const s=1+Math.abs(Math.sin(t*3))*0.15;
    loveMesh.scale.set(s,s,1);
  } else loveMesh.visible=false;

  renderer.render(scene,camera);
}

function updateParticles(group,type){
  const pos = group.geometry.attributes.position.array;
  const target =
    state==='TREE'?  group.geometry.userData.tree :
    state==='HEART'? group.geometry.userData.heart :
                     group.geometry.userData.explode;

  for(let i=0;i<pos.length;i++){
    pos[i] += (target[i] - pos[i]) * 0.06;
  }
  group.geometry.attributes.position.needsUpdate = true;
}

/* ********************************************
   START SYSTEM + HAND TRACKING OPTIMIZED
******************************************** */
let lastAI = 0; // reduce Mediapipe load

function startSystem(){
  document.getElementById("btnStart").style.display="none";
  bgMusic.play().catch(()=>{});

  init3D();

  const video = document.querySelector(".input_video");
  const hands = new Hands({ locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
  hands.setOptions({
    maxNumHands:2,
    modelComplexity:0,    // üî• lighter model
    minDetectionConfidence:0.5,
    minTrackingConfidence:0.5
  });

  hands.onResults(res=>{
    const now = performance.now();
    if(now-lastAI < 120) return;   // üî• process only every 120ms
    lastAI = now;

    if(!res.multiHandLandmarks || res.multiHandLandmarks.length===0){
      state='TREE'; return;
    }

    const lm = res.multiHandLandmarks[0];
    const tips=[8,12,16,20];
    let d=0;
    tips.forEach(i=>{ d+=Math.hypot(lm[i].x-lm[0].x, lm[i].y-lm[0].y); });
    d/=4;
    const pinch = Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y);

    handX = lm[9].x;

    if(d<0.25) state='TREE';
    else if(pinch<0.05) state='PHOTO';
    else state='EXPLODE';
  });

  const cam = new Camera(video,{
    onFrame: async()=>{ await hands.send({ image:video }); },
    width:640, height:480
  });
  cam.start();
}

// resize
window.addEventListener("resize",()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
